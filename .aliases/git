#dotfiles git (rather than dfr (dotfiles repo) which is too close to drf (docker run fast.)) also deathfire grasp.

alias dfg='git --git-dir=$HOME/.dotfiles-repo/ --work-tree=$HOME'


function fix_symlink_for_dotfiles() {
	#Check input file is a symlink
	if [ -L "$1" ]; then
		symlink=$1
		target=`readlink "$symlink"`
		#if the symlink goes inside the home directory; make it relative.
		if [[ $target == /home/* ]]; then
			#ln -srf $target $symlink #actually skips intermediate symlinks when -r option is given; not an acceptable solution.
			echo "Fixing: $symlink"
			targetname=`basename $target`
			targetdir=${target%$targetname}
			symlinkname=`basename $symlink`
			symlinkdir=${symlink%$symlinkname}
			reltargetdir=`realpath --relative-to=$symlinkdir $targetdir`
			reltarget=$reltargetdir/$targetname
			ln -sf $reltarget $symlink
		elif [[ $target == /* ]]; then
			echo "Found non-relative symlink in dotfiles:"
			ls -l $symlink
		fi
	fi
}

function fix_symlinks_for_dotfiles() {
	dfg ls-tree -r --name-only --full-tree HEAD | while read line; do fix_symlink_for_dotfiles $line; done
}

alias dfgfixsym='fix_symlinks_for_dotfiles'
alias dfgso='dfg remote set-url origin git@github.com:Patricol/dotfiles.git'
alias dfgk='dfgso && add_ssh_keys github'

alias dfgs='dfg status --ahead-behind'

alias dfgd='dfg diff'
alias dfgdc='dfgd --cached'

#provide the branch to pull changes from as an arg
alias dfgdt='dfg difftool -y -t meld'
alias dfgdtm='dfgdt master'
alias dfgdtp='dfgdt archpatricol'
alias dfgdtw='dfgdt archwork'
alias dfgdtda='dfgdt dockerarch'
alias dfgdtdu='dfgdt dockerubuntu'

alias dfgmt='dfg mergetool -t meld'


function getnewcommits() {
	branch=$1
	dfg rev-list $(dfg merge-base -a $branch master)..$branch
}

function hasunmerged() {
	branch=$1
	commitcount=$(getnewcommits $branch | wc -l)
	if [ $commitcount -ge 2 ]; then
		return 0
	else
		echo "no unmerged changes"
		return 1
	fi
}

alias dfghump='hasunmerged archpatricol'
alias dfghumw='hasunmerged archwork'
alias dfghumda='hasunmerged dockerarch'
alias dfghumdu='hasunmerged dockerubuntu'

#find merge commit
function dfgfmc() {
	branch=$1
	getnewcommits $branch | tail -n 1
}
# ours-merge merge commit
alias dfgommcp='dfg merge -s ours $(dfgfmc archpatricol)'
alias dfgommcw='dfg merge -s ours $(dfgfmc archwork)'
alias dfgommcda='dfg merge -s ours $(dfgfmc dockerarch)'
alias dfgommcdu='dfg merge -s ours $(dfgfmc dockerubuntu)'


alias dfgmac='dfg merge --edit --no-ff'
alias dfgm='dfgmac --no-commit'
alias dfgmacm='dfgmac master'
alias dfgmm='dfgm master'
alias dfgmp='dfgm archpatricol'
alias dfgmw='dfgm archwork'
alias dfgmda='dfgm dockerarch'
alias dfgmdu='dfgm dockerubuntu'

alias dfga='dfg add'
alias dfgaa='dfgfixsym && dfga -u && dfga ~/.themes ~/.aliases ~/.config/wpg ~/.config/systemd ~/.config/powerline ~/.config/wallpapers ~/.config/qt5ct/'
alias dfgaae='dfgaa && dfg reset HEAD -- ~/.config/htop/htoprc'
alias dfgc='dfg commit -v'
alias dfgac='dfgaa && dfgc'

alias dfgch='dfg checkout'
alias dfgchm='dfgch master'
alias dfgchp='dfgch archpatricol'
alias dfgchw='dfgch archwork'
alias dfgchda='dfgch dockerarch'
alias dfgchdu='dfgch dockerubuntu'

alias dfgpop='dfg stash pop'
alias dfgpopall='while dfgpop; do :; done'

alias dfgp='dfgk && dfg push'

#to avoid merging branch-specific changes back into master; use "dfg merge -s ours BRANCH" when the BRANCH is only ahead by its merge commit.

#merge to master from ...
alias dfgmtmfp='dfgchm && dfghump && dfgommcp && dfgmp && dfg reset'
alias dfgmtmfw='dfgchm && dfghumw && dfgommcw && dfgmw && dfg reset'
alias dfgmtmfda='dfgchm && dfghumda && dfgommcda && dfgmda && dfg reset'
alias dfgmtmfdu='dfgchm && dfghumdu && dfgommcdu && dfgmdu && dfg reset'

#alias dfgfullmerge='dfgchp && dfgmw && dfg stash && dfgchda && dfgmdu && dfg stash && dfgchp && dfgpopall && dfgmda && dfgacm && dfgchw && dfgmp && dfgacm && dfgchda && dfgpopall && dfgmp && dfgacm && dfgchdu && dfgmda && dfgacm'
alias dfgmergeall='dfgfullmerge'

alias dfgpopush='dfgpopall && dfgs && dfgp'
alias dfgpushall='dfgchm && dfgpopush && dfgchdu && dfgpopush && dfgchda && dfgpopush && dfgchw && dfgpopush && dfgchp && dfgpopush'

alias gsf='sudo git --git-dir=/root/.systemfiles-repo/ --work-tree=/'

